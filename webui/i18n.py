"""
Internationalization (i18n) support for MSST WebUI
"""

import os
import json

_CONFIG_FILE = os.path.join(
    os.path.dirname(os.path.dirname(__file__)), ".webui_config.json"
)


def _load_config():
    try:
        if os.path.exists(_CONFIG_FILE):
            with open(_CONFIG_FILE, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception:
        pass
    return {}


def _save_config(config):
    try:
        with open(_CONFIG_FILE, "w", encoding="utf-8") as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
    except Exception:
        pass


TRANSLATIONS = {
    "en": {
        "app_title": "MSST - Music Source Separation",
        "app_subtitle": "Music Source Separation Training and Inference with Intel XPU Support",
        "powered_by": "Powered by Intel XPU (IPEX) and Gradio",
        "tab_inference": "Inference",
        "tab_training": "Training",
        "tab_models": "Models",
        "tab_settings": "Settings",
        "inference_title": "Audio Separation",
        "inference_desc": "Upload audio files and separate them into stems.",
        "upload_audio": "Upload Audio Files",
        "model_type": "Model Type",
        "config_file": "Config File (.yaml)",
        "checkpoint_file": "Checkpoint File",
        "extract_instrumental": "Extract Instrumental",
        "separate_btn": "Separate",
        "status": "Status",
        "separated_files": "Separated Files",
        "preview": "Preview",
        "output_dir": "Output Directory",
        "use_tta": "Use TTA (Test Time Augmentation)",
        "training_title": "Model Training",
        "training_desc": "Configure and run training for music source separation models.",
        "data_paths": "Data Paths (separated by ';')",
        "valid_paths": "Validation Paths (separated by ';')",
        "results_path": "Results Path",
        "num_workers": "Number of Workers",
        "device_ids": "Device IDs",
        "start_training": "Start Training",
        "stop_training": "Stop Training",
        "training_status": "Status",
        "training_log": "Training Log",
        "training_loss": "Training Loss",
        "ready": "Ready",
        "start_checkpoint": "Start Checkpoint (optional)",
        "models_title": "Model Management",
        "models_desc": "Download, view, and manage your models.",
        "local_models": "Local Models",
        "installed_models": "Installed Models",
        "refresh_list": "Refresh List",
        "select_delete": "Select Model to Delete",
        "delete": "Delete",
        "download_models": "Download Models",
        "available_download": "Available for Download",
        "select_download": "Select Model to Download",
        "download": "Download",
        "download_status": "Download Status",
        "model_details": "Model Details",
        "model_config": "Model Configuration",
        "settings_title": "Settings",
        "settings_desc": "Configure application settings and view system information.",
        "device_settings": "Device Settings",
        "current_device": "Current Device",
        "preferred_device": "Preferred Device",
        "auto_device": "Auto (XPU > CPU)",
        "paths": "Paths",
        "default_output_dir": "Default Output Directory",
        "models_dir": "Models Directory",
        "configs_dir": "Configs Directory",
        "system_info": "System Information",
        "system_details": "System Details",
        "refresh_info": "Refresh System Info",
        "save_load": "Save/Load",
        "save_settings": "Save Settings",
        "load_settings": "Load Settings",
        "language": "Language",
        "select_language": "Select Language",
        "exit": "Exit",
        "error": "Error",
        "error_no_audio": "Please upload audio files",
        "error_no_config": "Config file not found",
        "error_no_checkpoint": "Checkpoint file not found",
        "error_no_model": "Please select a model",
        "error_model_not_found": "Model not found",
        "select_model": "Select Model",
        "batch_size": "Batch Size",
        "batch_size_info": "Lower = less VRAM, slower. Higher = more VRAM, faster",
        "num_overlap": "Overlap",
        "num_overlap_info": "Higher = better quality, slower",
        "chunk_size": "Chunk Size",
        "chunk_size_info": "Lower = less VRAM. Default: 352800",
        "normalize": "Normalize Audio",
        "output_format": "Output Format",
        "input_folder": "Input Folder (optional)",
        "input_folder_placeholder": "Path to folder containing audio files",
        "msst_separation": "MSST Separation",
        "uvr_separation": "UVR Separation",
        "uvr_not_implemented": "UVR ONNX inference is not yet implemented. Please use MSST models.",
        "uvr_note": "UVR models require ONNX Runtime. Install with: pip install onnxruntime",
        "uvr_install_onnxruntime": "Please install ONNX Runtime: pip install onnxruntime",
        "separation_complete": "Separation complete! {count} files created.",
        "separation_no_output": "Separation complete but no output files found.",
        "training_started": "Training started...",
        "training_stopped": "Training stopped.",
        "training_running": "Training is running...",
        "training_error": "Training error",
        "category_filter": "Category Filter",
        "all_categories": "All Categories",
        "window_size": "Window Size",
        "window_size_info": "Processing window size. Larger = more memory",
        "aggression": "Aggression",
        "aggression_info": "Separation intensity (-100 to 100, default 5)",
        "post_process_threshold": "Post Process Threshold",
        "invert_spectrogram": "Invert Spectrogram",
        "enable_tta": "Enable TTA",
        "high_end_process": "High End Process",
        "enable_post_process": "Enable Post Process",
        "import_custom_model": "Import Custom Model",
        "import_msst_model": "Import MSST Model",
        "import_uvr_model": "Import UVR Model",
        "select_model_file": "Select Model File",
        "select_config_file": "Select Config File",
        "model_name": "Model Name (optional)",
        "model_name_placeholder": "Leave empty to use filename",
        "import_btn": "Import",
        "import_success": "Model imported successfully!",
        "import_error": "Import failed",
        "validate_model": "Validate Model",
        "validation_success": "Model validation passed!",
        "validation_failed": "Model validation failed",
        "auto_detect_type": "Auto-detect model type",
        "detected_type": "Detected Type",
        "no_file_selected": "No file selected",
        "file_not_found": "File not found",
        "file_copied": "File copied to",
        "organize_models": "Organize Models",
        "organize_success": "Organized {count} models into category folders",
        "organize_errors": "Moved {count} models. Errors:",
        "no_models_to_organize": "No models to organize",
        "please_select_model": "Please select a model",
        "model_not_found": "Model not found",
        "downloading": "Downloading {name}...",
        "download_success": "downloaded successfully!",
        "deleted": "deleted",
        "deleted_files": "Deleted: {files}",
        "saved": "Saved ✓",
        "save_failed": "Save failed",
        "loaded": "Loaded ✓",
        # Training sub-tabs
        "tab_train": "Train",
        "tab_valid": "Validate",
        "tab_guide": "Dataset Guide",
        # Training parameters
        "dataset_type": "Dataset Type",
        "dataset_type_1": "Type 1 - MUSDB format (folder per song with stems)",
        "dataset_type_2": "Type 2 - Stems in separate folders",
        "dataset_type_3": "Type 3 - CSV metadata",
        "dataset_type_4": "Type 4 - Custom format",
        "use_multistft_loss": "Use MultiSTFT Loss",
        "use_mse_loss": "Use MSE Loss",
        "use_l1_loss": "Use L1 Loss",
        "pre_valid": "Validate Before Training",
        "metrics": "Metrics",
        "metric_for_scheduler": "Metric for Scheduler",
        "seed": "Random Seed",
        "pin_memory": "Pin Memory",
        # Validation
        "valid_title": "Model Validation",
        "valid_desc": "Validate a trained model and compute evaluation metrics.",
        "store_dir": "Output Directory",
        "extension": "Audio Extension",
        "start_validation": "Start Validation",
        "stop_validation": "Stop Validation",
        "validation_status": "Validation Status",
        "validation_log": "Validation Log",
        "validation_started": "Validation started...",
        "validation_stopped": "Validation stopped.",
        "validation_running": "Validation is running...",
        "validation_error": "Validation error",
        # Dataset guide
        "guide_title": "Dataset Preparation Guide",
        # Log management
        "tab_logs": "History Logs",
        "log_files": "Log Files",
        "select_log": "Select Log File",
        "view_log": "View Log",
        "delete_log": "Delete Selected",
        "delete_all_logs": "Delete All Logs",
        "log_content": "Log Content",
        "no_logs": "No log files found",
        "log_deleted": "Log deleted",
        "all_logs_deleted": "All logs deleted",
        "confirm_delete_all": "Are you sure you want to delete all logs?",
    },
    "zh": {
        "app_title": "MSST - 音乐源分离",
        "app_subtitle": "支持Intel XPU的音乐源分离训练与推理",
        "powered_by": "基于 Intel XPU (IPEX) 和 Gradio",
        "tab_inference": "推理",
        "tab_training": "训练",
        "tab_models": "模型管理",
        "tab_settings": "设置",
        "inference_title": "音频分离",
        "inference_desc": "上传音频文件并分离成不同音轨。",
        "upload_audio": "上传音频文件",
        "model_type": "模型类型",
        "config_file": "配置文件 (.yaml)",
        "checkpoint_file": "模型权重文件",
        "extract_instrumental": "提取伴奏",
        "separate_btn": "开始分离",
        "status": "状态",
        "separated_files": "分离结果",
        "preview": "预览",
        "output_dir": "输出目录",
        "use_tta": "使用TTA（测试时增强）",
        "training_title": "模型训练",
        "training_desc": "配置并运行音乐源分离模型训练。",
        "data_paths": "数据路径（用';'分隔）",
        "valid_paths": "验证集路径（用';'分隔）",
        "results_path": "结果保存路径",
        "num_workers": "工作进程数",
        "device_ids": "设备ID",
        "start_training": "开始训练",
        "stop_training": "停止训练",
        "training_status": "状态",
        "training_log": "训练日志",
        "training_loss": "训练损失",
        "ready": "就绪",
        "start_checkpoint": "起始检查点（可选）",
        "models_title": "模型管理",
        "models_desc": "下载、查看和管理模型。",
        "local_models": "本地模型",
        "installed_models": "已安装模型",
        "refresh_list": "刷新列表",
        "select_delete": "选择要删除的模型",
        "delete": "删除",
        "download_models": "下载模型",
        "available_download": "可下载模型",
        "select_download": "选择要下载的模型",
        "download": "下载",
        "download_status": "下载状态",
        "model_details": "模型详情",
        "model_config": "模型配置",
        "settings_title": "设置",
        "settings_desc": "配置应用设置并查看系统信息。",
        "device_settings": "设备设置",
        "current_device": "当前设备",
        "preferred_device": "首选设备",
        "auto_device": "自动 (XPU > CPU)",
        "paths": "路径设置",
        "default_output_dir": "默认输出目录",
        "models_dir": "模型目录",
        "configs_dir": "配置目录",
        "system_info": "系统信息",
        "system_details": "系统详情",
        "refresh_info": "刷新系统信息",
        "save_load": "保存/加载",
        "save_settings": "保存设置",
        "load_settings": "加载设置",
        "language": "语言",
        "select_language": "选择语言",
        "exit": "退出",
        "error": "错误",
        "error_no_audio": "请上传音频文件",
        "error_no_config": "未找到配置文件",
        "error_no_checkpoint": "未找到模型权重文件",
        "error_no_model": "请选择一个模型",
        "error_model_not_found": "模型未找到",
        "select_model": "选择模型",
        "batch_size": "批处理大小",
        "batch_size_info": "越小显存占用越少但速度越慢，越大显存占用越多但速度越快",
        "num_overlap": "重叠次数",
        "num_overlap_info": "越大质量越好但速度越慢",
        "chunk_size": "块大小",
        "chunk_size_info": "越小显存占用越少。默认: 352800",
        "normalize": "音频归一化",
        "output_format": "输出格式",
        "input_folder": "输入文件夹（可选）",
        "input_folder_placeholder": "包含音频文件的文件夹路径",
        "msst_separation": "MSST 分离",
        "uvr_separation": "UVR 分离",
        "uvr_not_implemented": "UVR ONNX 推理尚未实现，请使用 MSST 模型。",
        "uvr_note": "UVR 模型需要 ONNX 运行时。请安装：pip install onnxruntime",
        "uvr_install_onnxruntime": "请安装 ONNX 运行时：pip install onnxruntime",
        "separation_complete": "分离完成！已创建 {count} 个文件。",
        "separation_no_output": "分离完成但未找到输出文件。",
        "training_started": "训练已开始...",
        "training_stopped": "训练已停止。",
        "training_running": "训练进行中...",
        "training_error": "训练错误",
        "category_filter": "类别筛选",
        "all_categories": "全部类别",
        "window_size": "窗口大小",
        "window_size_info": "处理窗口大小。越大内存占用越多",
        "aggression": "分离强度",
        "aggression_info": "分离强度 (-100 到 100, 默认 5)",
        "post_process_threshold": "后处理阈值",
        "invert_spectrogram": "反转频谱",
        "enable_tta": "启用TTA",
        "high_end_process": "高频处理",
        "enable_post_process": "启用后处理",
        "import_custom_model": "导入自定义模型",
        "import_msst_model": "导入 MSST 模型",
        "import_uvr_model": "导入 UVR 模型",
        "select_model_file": "选择模型文件",
        "select_config_file": "选择配置文件",
        "model_name": "模型名称（可选）",
        "model_name_placeholder": "留空则使用文件名",
        "import_btn": "导入",
        "import_success": "模型导入成功！",
        "import_error": "导入失败",
        "validate_model": "验证模型",
        "validation_success": "模型验证通过！",
        "validation_failed": "模型验证失败",
        "auto_detect_type": "自动检测模型类型",
        "detected_type": "检测到的类型",
        "no_file_selected": "未选择文件",
        "file_not_found": "文件未找到",
        "file_copied": "文件已复制到",
        "organize_models": "整理模型",
        "organize_success": "已将 {count} 个模型整理到分类文件夹",
        "organize_errors": "已移动 {count} 个模型。错误:",
        "no_models_to_organize": "没有需要整理的模型",
        "please_select_model": "请选择一个模型",
        "model_not_found": "模型未找到",
        "downloading": "正在下载 {name}...",
        "download_success": "下载成功！",
        "deleted": "已删除",
        "deleted_files": "已删除: {files}",
        "saved": "保存成功 ✓",
        "save_failed": "保存失败",
        "loaded": "加载成功 ✓",
        "tab_train": "训练",
        "tab_valid": "验证",
        "tab_guide": "数据集指南",
        "dataset_type": "数据集类型",
        "dataset_type_1": "类型1 - MUSDB格式（每首歌一个文件夹含各音轨）",
        "dataset_type_2": "类型2 - 音轨分别存放在不同文件夹",
        "dataset_type_3": "类型3 - CSV元数据",
        "dataset_type_4": "类型4 - 自定义格式",
        "use_multistft_loss": "使用MultiSTFT损失",
        "use_mse_loss": "使用MSE损失",
        "use_l1_loss": "使用L1损失",
        "pre_valid": "训练前验证",
        "metrics": "评估指标",
        "metric_for_scheduler": "调度器指标",
        "seed": "随机种子",
        "pin_memory": "固定内存",
        "valid_title": "模型验证",
        "valid_desc": "验证训练好的模型并计算评估指标。",
        "store_dir": "输出目录",
        "extension": "音频扩展名",
        "start_validation": "开始验证",
        "stop_validation": "停止验证",
        "validation_status": "验证状态",
        "validation_log": "验证日志",
        "validation_started": "验证已开始...",
        "validation_stopped": "验证已停止。",
        "validation_running": "验证进行中...",
        "validation_error": "验证错误",
        "guide_title": "数据集制作指南",
        "tab_logs": "历史日志",
        "log_files": "日志文件",
        "select_log": "选择日志文件",
        "view_log": "查看日志",
        "delete_log": "删除选中",
        "delete_all_logs": "删除全部日志",
        "log_content": "日志内容",
        "no_logs": "没有找到日志文件",
        "log_deleted": "日志已删除",
        "all_logs_deleted": "全部日志已删除",
        "confirm_delete_all": "确定要删除全部日志吗？",
    },
}


def get_lang():
    config = _load_config()
    return config.get("language", "zh")


def set_lang(lang: str):
    if lang in TRANSLATIONS:
        config = _load_config()
        config["language"] = lang
        _save_config(config)


def t(key: str) -> str:
    current_lang = get_lang()
    return TRANSLATIONS.get(current_lang, TRANSLATIONS["en"]).get(key, key)


def get_all_translations():
    current_lang = get_lang()
    return TRANSLATIONS.get(current_lang, TRANSLATIONS["en"])
